Bootstrap: docker
From: nvidia/cuda:12.8.1-devel-ubuntu24.04

%files from builder
	apt.conf /etc/apt/
%environment
    export PYTHONUNBUFFERED=1
    export HF_HOME=/scratch/huggingface
    export TRANSFORMERS_CACHE=/scratch/huggingface/hub

%post
    apt-get update && apt-get install -y \
        python3 python3-venv python3-pip git \
        && rm -rf /var/lib/apt/lists/*

    ln -sf /usr/bin/python3 /usr/bin/python

    pip install --no-cache-dir --break-system-packages \
        "torch==2.6.0" --index-url https://download.pytorch.org/whl/cu128
    pip install --no-cache-dir --break-system-packages \
        "transformers==4.54.1" \
        "peft>=0.13.0" \
        "bitsandbytes>=0.43.0" \
        "trl>=0.12.0" \
        datasets \
        accelerate \
        wandb \
        pyyaml

%runscript
    python /workspace/train_qlora.py "$@"
